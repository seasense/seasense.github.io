<html>
	<head>
		<title>SymmetrySpan</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<script src="jspsych-5.0.3-sym/jspsych.js"></script>

		<script src="jspsych-5.0.3-sym/plugins/jspsych-text.js"></script>
		
		<script src="jspsych-5.0.3-sym/plugins/jspsych-button-response-judgeSym.js"></script>
		<script src="jspsych-5.0.3-sym/plugins/jspsych-button-response-hitCells.js"></script>
		<script src="jspsych-5.0.3-sym/plugins/jspsych-instructions.js"></script>
		
		<script src="jspsych-5.0.3-sym/plugins/equations.js"></script>
		<script src="jspsych-5.0.3-sym/plugins/jspsych-survey-text_persCode.js"></script>
		<script src="jspsych-5.0.3-sym/plugins/jspsych-survey-multi-choice.js"></script>
		<script src="jspsych-5.0.3-sym/plugins/jspsych-single-stim.js"></script>
		
		<script src="jspsych-5.0.3-sym/plugins/matrices.js"></script>
		<script src="jspsych-5.0.3-sym/plugins/jspsych-rememberCells.js"></script>
		<script src="jspsych-5.0.3-sym/plugins/jspsych-rememberCells-practice.js"></script>
		<link href="jspsych-5.0.3-sym/css/jspsych_symSpan.css" rel="stylesheet" type="text/css"></link>
		
		<style>
			:root{
				--normalTextSize: 20px;
				--cellSize_symMat: 40px;
				--cellSize_remMat: 60px;
				--numberSize_remMat: 40px;
				
			}
		</style>

	</head>
	
	
	<script>
		function rememberCellsFx (t_SetSize) {
			
			var cells_trial_x = [];
			var alreadySampled = [];
			for(i=0;i<t_SetSize;i++){
				var sample_i = Math.floor(Math.random()*16);
				if(alreadySampled.includes(sample_i)===false){
					cells_trial_x.push(sample_i);
					alreadySampled.push(sample_i);
				};
			};
			
			return cells_trial_x
		};

		function successCountrFx (successCountr_sym,pattern,b_pressed){
			if(pattern=="symmetrical"&b_pressed==1){successCountr_sym+=1}
			if(pattern=="asymmetrical"&b_pressed==0){successCountr_sym+=1}
			return(successCountr_sym)
		}

		function symFeedback (nErrorFreeTrials_symPractice,successCountr_sym,pattern,b_pressed){
			

			if(pattern=="symmetrical"){
					if(b_pressed==1){
						
						nTrials_remaining = nErrorFreeTrials_symPractice-successCountr_sym-1;
						if(nTrials_remaining==0){ feedText = "Richtig. Das pr&#xE4;sentierte Muster war symmetrisch."+"<br>"+"Der &#xDC;bungsdurchgang ist beendet!"+"<br>"+"Klicke Weiter um fortzufahren."}else{feedText = "Richtig. Das pr&#xE4;sentierte Muster war symmetrisch."+"<br>"+nTrials_remaining+" von "+(nErrorFreeTrials_symPractice-1)+" verbleibenden fehlerfreien Durchg&#xE4;ngen."}	
					}else{
						nTrials_remaining = nErrorFreeTrials_symPractice-successCountr_sym-1;
						feedText = "Falsch. Das pr&#xE4;sentierte Muster war symmetrisch."+"<br>"+nTrials_remaining+" von "+(nErrorFreeTrials_symPractice-1)+" verbleibenden fehlerfreien Durchg&#xE4;ngen."}
				}
				if(pattern=="asymmetrical"){
					if(b_pressed==0){
						
						nTrials_remaining = nErrorFreeTrials_symPractice-successCountr_sym-1;
						if(nTrials_remaining==0){feedText = "Richtig. Das gezeigte Muster war asymetrisch."+"<br>"+"Vielen Dank! Der &#xDC;bungsdurchgang (a) ist nun zu Ende."+"<br>"+" Klicken Sie <i>Weiter</i>, um nun mit der &#xDC;bung (b) zu beginnen."}else{feedText = "Richtig. Das gezeigte Muster war asymmetrisch."+"<br>"+nTrials_remaining+" von "+(nErrorFreeTrials_symPractice-1)+" verbleibenden fehlerfreien Durchg&#xE4;ngen."}
					}else{
						nTrials_remaining = nErrorFreeTrials_symPractice-successCountr_sym-1;
						feedText = "Falsch. Das gezeigte Muster war asymmetrisch."+"<br>"+nTrials_remaining+" von of "+(nErrorFreeTrials_symPractice-1)+" verbleibenden fehlerfreien Durchg&#xE4;ngen."}
				}

				return feedText
		}

	</script>

	<script>
		function add(a, b) {
    		return a + b;
		}
	</script>
	
	<script>
	var trials = [2,2,2,3,3,3,4,4,4,5,5,5,6,6,6]
	//var trials = [3,4];
	var trials_seq = jsPsych.randomization.repeat(trials, 1);
	var nTrials = trials_seq.length;
	var nPerSetSize = 3;
	
	var rangePracticeSetSize = {min:3,max:3};
	var practiceCriterion = 1;

	var nErrorFreeTrials_symPractice = 3;
	

	
///////// Intro
/////////
	var welcome = {
			type: 'instructions',
			pages: [
			//<p>Aus unserem allt&#xE4;glichen Leben ist uns wahrscheinlich allen bekannt, dass es schwierig sein kann mehrere Aufgaben gleichzeitig, zu absolvieren. 
					"<p class='center-content'> Willkommen zum <b style='color:#008080'>SymSpan-Task</b>! <p> In dieser Aufgabe werden Ihre Multitasking-F&#xE4;higkeiten auf die Probe gestellt, indem Sie in einer simulierten Situation zwei Aufgaben parallel bearbeiten m&#xFC;ssen. <p>(a) In der Symmetrie-Aufgabe muss entschieden werden, ob das gezeigte Muster (schwarz und wei&#xDF; eingef&#xE4;rbter Felder innerhalb einer Matrix) symmetrisch entlang seiner Horizontalen ist oder nicht. <br>(b) In der Ged&#xE4;chtnisaufgabe gilt es, sich die Positionen von  farbig erscheinenden Feldern innerhalb einer 4x4 Matrix zu merken. <p>Der gesamte Task (inklusive &#xDC;bungsdurchgang) dauert 12-15 Minuten.<p>Klicken Sie <i>Weiter</i>, um fortzusetzen und zun&#xE4;chst Ihre Einwilligungserkl&#xE4;rung zur Teilnahme abzugeben."],
			show_clickable_nav: true
			};
	var informedConsent = {
		type: 'survey-multi-choice',
		questions: ["<p> <b>Aufgabenbeschreibung & Einverst&#xE4;ndniserkl&#xE4;rung</b> <p> <i> Voluntariness </i> <br> You may revoke your consent to participate at any time and without stating any reasons. <p> <i> Storage of data </i> <br>All your data will be written automatically to a database on a server of Tallinn University. <p> <i> Protection of data privacy </i> <br> The entire dataset will be made fully anonymous, which means that your data cannot be related to you as an individual. <p> <i> Usage of anonymized data </i> <br> The results and data from this study will be used for a scientific publication. Anonymity of the participants will be ensured in this process. The fully anonymized data from this study will be made accessible as open data on the internet via the data archive <i> PsychData (Research Data for Psychology, Leibnitz Institute for Psychology Information ZPID) </i> <b> <br> <br> <p> If you agree on our data management, click the radio button below and hit <i>Submit Answer</i>. Otherwise, press <i>Escape</i> on your keyboard to exit the environment."],
		options: [["I hereby confirm that I have read, understood and accept the provided information concerning storage, protection and usage of my data."]],
		required: [true]
    };

    var informedConsent1 = {
		type: 'survey-multi-choice',
		questions: ["<b>Einverst&#xE4;ndniserkl&#xE4;rung </b>1/3"],
		options: [["Ich habe die Aufgabenbeschreibung gelesen und erkl&aumlre mich bereit zur Teilnahme."]],
		required: [true]
    };
	var informedConsent2 = {
		type: 'survey-multi-choice',
		questions: ["<b>Einverst&#xE4;ndniserkl&#xE4;rung </b>2/3"],
		options: [["Ich stimme zu, dass meine pseudonymisierten Daten zur Ver&oumlffentlichung wissenschaftlicher Arbeiten verwendet werden."]],
		required: [true]
    };
    var informedConsent3 = {
		type: 'survey-multi-choice',
		questions: ["<b>Einverst&#xE4;ndniserkl&#xE4;rung </b>3/3"],
		options: function(){return([["Ich stimme zu, dass meine pseudonymisierten Daten zum Zweck der wissenschaftlichen Transparenz f&uumlr andere WissenschaftlerInnen im <a href='https://osf.io/'> Open Science Framework </a> verf&uumlgbar gemacht werden."]])},
		required: [true]
    };

	var persData_code = ["<p> Generieren Sie Ihren anonymisierten Personencode:"];
	var demographics = {
	  		type: "survey-text-persCode",
	  		questions: persData_code,
			preamble: "<b>Personencode</b>: <br>Position 1: Erste Buchstabe des Vornamens ihrer Mutter <br> Position 2: Erste Buchstabe des Vornamens ihres Vaters <br> Positions 3 und 4: Ihr Geburtsjahr <br> Position 5: Der erste Buchstabe ihrer Adresse <br> Position 6: Die erste Zahl ihrer Hausnummer <p> Beispiel: FC84M4"
	};
	
///////// Practice
	var practice_overview = {
		type: 'instructions',
		pages: ["<p>***</p> Es folgen zun&#xE4;chst drei kurze &#xDC;bungseinheiten, welche den SymSpan-Task Schritt f&#xFC;r Schritt erkl&#xE4;ren:<p><b>a)</b> Symmetrie-Aufgabe<br><b>b)</b> Ged&#xE4;chtnisaufgabe<br><b>ab)</b> Beide Aufgaben zugleich (SymSpan-Task) <p>***</p>Klicken Sie <i>Weiter</i>, um mit der ersten &#xDC;bungseinheit zu beginnen."],
		show_clickable_nav: true,
	};
///////// Practice Symmetry
	
	var intro_symmetry_practice = {
			type: 'instructions',
			pages: function(){return ["<p class='center-content'><b>Symmetrie-Aufgabe: Instruktion</b></p> Wenn Sie auf den <i>Weiter</i>-Button klicken, erscheint ein Plus-Zeichen <b>+</b>, gefolgt von hintereinander pr&#xE4;sentierten Matrizen, die jeweils ein bestimmtes Muster aus schwarzen und wei&#xDF;en Feldern darstellen. Bei jeder dieser Matrizen gilt es zu entscheiden, ob das jeweilige Muster symmetrisch entlang seiner Horizontalen ist oder nicht.</p> Der &#xDC;bungsdurchgang muss fehlerfrei absolviert werden, um zur n&#xE4;chsten &#xDC;bungseinheit zu gelangen. </p><p class='center-content'> Klicken Sie <i>Weiter</i>, um zu beginnen.</p><p>"]},
			show_clickable_nav: true,
			on_finish: function(data) { 
				successCountr_sym = 0;
			},
	};

	var symmetry_buttons = [ ["Nein"] , ["Ja"] ];
	var symmetry = {
		    type: 'judgeSym',
			is_html: true, 
			prompt: "Ist das Muster symmetrisch?",
		    choices: symmetry_buttons,
	 	   	on_finish: function(data){
	 	   		pattern = data.matrixPattern
				b_pressed = data.button_pressed
				successCountr_sym = successCountrFx(successCountr_sym, pattern, b_pressed)
				console.log(successCountr_sym);
	 	   	},
		};

	var feedback_symmetry_0 = {
		type: 'text',
		text: function(){return symFeedback (nErrorFreeTrials_symPractice,successCountr_sym,pattern,b_pressed) },
		on_finish: function(data) { 
						
		}
	};

	var symmetry_loop_practice = {
		timeline: [symmetry,feedback_symmetry_0],
		loop_function: function(data){
		        
				if(successCountr_sym == (nErrorFreeTrials_symPractice-1)){
		            return false;
		        } else {
		            return true;
		        }
		  },
	};

///////// Practice Remember
	var intro_remember_practice = {
			type: 'instructions',
			pages: function(){return ["<p class='center-content'><b>Ged&#xE4;chtnisaufgabe: Instruktion</b></p> Wenn Sie auf <i>Weiter</i> klicken, erscheint eine 4x4-Matrix, innerhalb derer einzelne Felder hintereinander farbig aufleuchten werden. Anschlie&#xDF;end gilt es, alle zuvor erleuchteten Felder in der dargebotenen Reihenfolge zu erinnern (durch Klicken der Felder der Matrix).</p></p><p class='center-content'> Klicken Sie <i>Weiter</i>, um den &#xDC;bungsdurchgang zu starten.</p><p>"]},
			show_clickable_nav: true,
			on_finish: function(data) { 
				t_SetSize = getRndInteger(rangePracticeSetSize.min,rangePracticeSetSize.max)
				remememberCells_trial_x = rememberCellsFx(t_SetSize);
				successCountr = 0;
			},
	};
	var plusSign = {
  	  	type: "single-stim",
		stimulus: "<p><p><b>+",
  	  	choices: [100], timing_response: 1200, data: {phase: 'remember'},
  	  	is_html: true
	};

	var remember = {
  	  	//type: "single-stim",
  	  	type: "rememberCells-practice",
  	  	flashingCells: function(){return(remememberCells_trial_x)},
		//stimulus: function(){var mat = matRememberFx(remememberCells_trial_x[rem_i]); return(mat)},
  	  	choices: [100], timing_response: function(){return(1000*(t_SetSize))}, data: {phase: 'remember'},
  	  	is_html: true,
 	   	on_finish: function(data){
 		   	 	   	},
		
	};

	var recall = {
  		type: 'button-response-hitCells',
  		is_html: true,
		stimulus: "Klicken Sie die Felder in der pr&#xE4;sentierten Reihenfolge an!",
		showEndButton: true,
		flashedCells: function(){return remememberCells_trial_x},
		response_ends_trial: false,
		on_finish: function(data) { 
			cells_presented = data.flashed_cells
			cells_clicked = data.clicked_cells
			
			cells_RecCorPos = data.Cells_RecCorPos
        	cells_RecIncorPos = data.Cells_RecIncorPos
        	cells_Missed = data.Cells_missed
        	cells_FalseMem = data.Cells_FalseMem

        	accuracy_score_rem = cells_RecCorPos.length/(cells_RecCorPos.length+cells_RecIncorPos.length+cells_Missed.length+cells_FalseMem.length);
        	accuracy_score_rem = Math.floor(accuracy_score_rem*100)
        	
		},	
	};


	var feedback_recall_0 = {
		type: 'instructions',
		pages: [ function(){return matFeedbackFx(cells_presented, cells_clicked, cells_RecCorPos, cells_RecIncorPos, cells_Missed, cells_FalseMem, accuracy_score_rem) } ],
		show_clickable_nav: true,
		on_finish: function(data) { 
			if(accuracy_score_rem==100){
				feedback_recall_message = "Sehr gut! Der &#xDC;bungsdurchgang ist zu Ende.";
				successCountr+=1;
			}else{
				feedback_recall_message = "Um den &#xDC;bungsdurchgang zu beenden, m&#xFC;ssen alle Felder richtig erinnert werden.";
				remememberCells_trial_x = rememberCellsFx(t_SetSize);
			}
		}
	};

	var feedback_recall_1 = {
		type: 'instructions',
		pages: [ function(){return ""+feedback_recall_message+"" } ],
		show_clickable_nav: true,
		on_finish: function(data) { 
			
		},
	};

	var recall_loop_practice = {
		timeline: [remember,recall,feedback_recall_0,feedback_recall_1],
		loop_function: function(data){
		        
				if(successCountr == 0){
		            return true;
		        } else {
		            return false;
		        }
		  },
	};
   
///////// Practice Symmetry & Remember
	var intro_RemAndSym_practice = {
			type: 'instructions',
			pages: function(){return ["<p class='center-content'><b>Beide Tasks zugleich (SymSpan-Task) Aufgabenbeschreibung</b></p> In jedem Durchgang sind abwechselnd eine Symmetrie-Aufgabe und eine Ged&#xE4;chtnisaufgabe zu absolvieren. <br>Die Aufgabe besteht wieder darin <p>(a) zu entscheiden, ob das gezeigte Muster symmetrisch entlang seiner horizontalen ist oder nicht und <p>(b) sich die Reihenfolge der farbig erleuchteten Felder zu merken. <p class='center-content'> Klicke <i>Weiter</i> um die &#xDC;bung zu beginnen.</p><p>"]},
			show_clickable_nav: true,
			on_finish: function(data) { 
				successCountr_sym = 0
				successCountr_rem = 0
				t_SetSize = getRndInteger(rangePracticeSetSize.min,rangePracticeSetSize.max)
				remememberCells_trial_x = rememberCellsFx(t_SetSize);
				rem_i = 0
				symDecisions = []
				symPatterns = []
				console.log(remememberCells_trial_x)
			},
	};

	var rem_RemAndSym = {
  	  	type: "single-stim",
  	  	stimulus: function(){
  	  		var mat = matRememberFx(remememberCells_trial_x[rem_i]);return(mat)},
  	  	choices: [100], timing_response: function(){return(500*(t_SetSize))}, data: {phase: 'remember'},
  	  	is_html: true,
 	   	on_finish: function(data){
 	   		rem_i+=1
 		},
		
	};
	var sym_RemAndSym = {
		    type: 'judgeSym',
			is_html: true, 
			prompt: "Ist das Muster symmetrisch?",
		    choices: symmetry_buttons,
	 	   	on_finish: function(data){
	 	   		pattern = data.matrixPattern
				b_pressed = data.button_pressed
				response = ["asymmetrical","symmetrical"][b_pressed]
				if(pattern==response){successCountr_sym+=1}
				symDecisions.push(response)
				symPatterns.push(pattern)
				console.log(symDecisions.length)
				console.log(successCountr_sym)
	 	   	},
		};

	var RemAndSym_loop = {
		timeline: [sym_RemAndSym,rem_RemAndSym],
		loop_function: function(data){
		        
				if(rem_i==remememberCells_trial_x.length){
		            return false;
		        } else {
		            return true;
		        }
		  },
	};

	var feedback_RemAndSym_0 = {
		type: 'instructions',
		pages: [ function(){return matFeedbackFx(cells_presented, cells_clicked, cells_RecCorPos, cells_RecIncorPos, cells_Missed, cells_FalseMem, accuracy_score_rem) } ],
		show_clickable_nav: true,
		on_finish: function(data) { 
			accuracy_score_sym = Math.floor((successCountr_sym/symDecisions.length)*100)
			if(accuracy_score_rem==100&accuracy_score_sym==100){
				feedback_recall_message = "Sehr gut! Der &#xDC;bungsdurchgang ist nun beendet."
			}else{
				feedback_recall_message = "Um den &#xDC;bungsdurchgang zu beenden m&#xFC;ssen alle gezeigten Felder richtig erinnert werden.";
			}
		}
	};

	var feedback_RemAndSym_1 = {
		type: 'instructions',
		pages: [ function(){return ""+"<b>"+"Symmetrie-Aufgabe"+"</b>"+"<br>"+"Die pr&#xE4;sentierten Muster waren: "+symPatterns+"<br>"+"Ihre Antworten waren: "+symDecisions+"<br>"+"<b>"+"Genauigkeit: "+accuracy_score_sym+"%" } ],
		show_clickable_nav: true,
		on_finish: function(data) { 
				
			}
		
	};

	var feedback_RemAndSym_2 = {
		type: 'instructions',
		pages: [ function(){return feedback_recall_message } ],
		show_clickable_nav: true,
		on_finish: function(data) { 
				t_SetSize = getRndInteger(rangePracticeSetSize.min,rangePracticeSetSize.max)
				remememberCells_trial_x = rememberCellsFx(t_SetSize);
				rem_i = 0
				successCountr_rem = 0
				successCountr_sym = 0
				symDecisions = []
				symPatterns = []
			}
		
	};

	var RemAndSym_loop2 = {
		timeline: [RemAndSym_loop,recall,feedback_RemAndSym_0,feedback_RemAndSym_1,feedback_RemAndSym_2],
		loop_function: function(data){
		        
				if(accuracy_score_rem==100&accuracy_score_sym==100){
		            return false;
		        } else {
		            return true;
		        }
		  },
	}

	
	var goodbye = {
			type: 'instructions',
			pages: [function(){return("Vielen Dank f&#xFC;r Ihre Teilnahme! <br>Klicken Sie <i>Weiter</i>, um den Download ihrer Daten in ihren Download-Folder zu veranlassen. Senden Sie dieses File anschlie&#xDF;end an die E-Mail Adresse: a01314341@unet.univie.ac.at ")}],
			show_clickable_nav: true,	
	};


/////////
	jsPsych.init({
		
		timeline: [welcome, /*informedConsent1, informedConsent2, informedConsent3,*/
					practice_overview,
					intro_symmetry_practice,symmetry_loop_practice,
					intro_remember_practice,recall_loop_practice,
					intro_RemAndSym_practice,RemAndSym_loop2,
					goodbye
					],

	   	fullscreen: false,
	   	on_finish: function(data){
	       jsPsych.data.localSave('myData_sendMeTo_pseiti@tlu.ee.txt', 'csv');
	   }
	});
	
	
		
	</script>
		
</html>